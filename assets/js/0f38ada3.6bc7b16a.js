"use strict";(self.webpackChunk_logto_docs=self.webpackChunk_logto_docs||[]).push([[5416],{9613:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return m}});var r=t(9496);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),m=a,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||o;return t?r.createElement(g,i(i({ref:n},p),{},{components:t})):r.createElement(g,i({ref:n},p))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,i=new Array(o);i[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=t[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},8661:function(e,n,t){t.d(n,{Z:function(){return i}});var r=t(9496),a=t(1626),o="tabItem_ZZXe";function i(e){var n=e.children,t=e.hidden,i=e.className;return r.createElement("div",{role:"tabpanel",className:(0,a.Z)(o,i),hidden:t},n)}},2418:function(e,n,t){t.d(n,{Z:function(){return m}});var r=t(5443),a=t(9496),o=t(1626),i=t(5874),s=t(2103),l=t(3299),c=t(2821),p="tabList_kQjL",d="tabItem_wrqk";function u(e){var n,t,i=e.lazy,u=e.block,m=e.defaultValue,g=e.values,h=e.groupId,k=e.className,f=a.Children.map(e.children,(function(e){if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),v=null!=g?g:f.map((function(e){var n=e.props;return{value:n.value,label:n.label,attributes:n.attributes}})),y=(0,s.l)(v,(function(e,n){return e.value===n.value}));if(y.length>0)throw new Error('Docusaurus error: Duplicate values "'+y.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var b=null===m?m:null!=(n=null!=m?m:null==(t=f.find((function(e){return e.props.default})))?void 0:t.props.value)?n:f[0].props.value;if(null!==b&&!v.some((function(e){return e.value===b})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+b+'" but none of its children has the corresponding value. Available values are: '+v.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var w=(0,l.U)(),N=w.tabGroupChoices,x=w.setTabGroupChoices,T=(0,a.useState)(b),I=T[0],C=T[1],j=[],S=(0,c.o5)().blockElementScrollPositionUntilNextRender;if(null!=h){var q=N[h];null!=q&&q!==I&&v.some((function(e){return e.value===q}))&&C(q)}var A=function(e){var n=e.currentTarget,t=j.indexOf(n),r=v[t].value;r!==I&&(S(n),C(r),null!=h&&x(h,String(r)))},U=function(e){var n,t=null;switch(e.key){case"ArrowRight":var r,a=j.indexOf(e.currentTarget)+1;t=null!=(r=j[a])?r:j[0];break;case"ArrowLeft":var o,i=j.indexOf(e.currentTarget)-1;t=null!=(o=j[i])?o:j[j.length-1]}null==(n=t)||n.focus()};return a.createElement("div",{className:(0,o.Z)("tabs-container",p)},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":u},k)},v.map((function(e){var n=e.value,t=e.label,i=e.attributes;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:I===n?0:-1,"aria-selected":I===n,key:n,ref:function(e){return j.push(e)},onKeyDown:U,onFocus:A,onClick:A},i,{className:(0,o.Z)("tabs__item",d,null==i?void 0:i.className,{"tabs__item--active":I===n})}),null!=t?t:n)}))),i?(0,a.cloneElement)(f.filter((function(e){return e.props.value===I}))[0],{className:"margin-top--md"}):a.createElement("div",{className:"margin-top--md"},f.map((function(e,n){return(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==I})}))))}function m(e){var n=(0,i.Z)();return a.createElement(u,(0,r.Z)({key:String(n)},e))}},1280:function(e,n,t){t.d(n,{ZP:function(){return l}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=["components"],s={toc:[]};function l(e){var n=e.components,t=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",null,'This tutorial assumes you have created an Application of type "',t.type,'" in Admin Console. If you are not ready,'," ",(0,o.kt)("a",{href:"../../tutorials/get-started/create-and-integrate-the-first-app"},"read this")," before continuing."))))}l.isMDXComponent=!0},9046:function(e,n,t){t.d(n,{ZP:function(){return l}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=["components"],s={toc:[]};function l(e){var n=e.components,t=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Let's switch to the Application details page of Admin Console in this section. Add a Redirect URI ",(0,o.kt)("code",null,t.redirectUri),' and click "Save Changes".'),(0,o.kt)("img",{alt:"Redirect URI in Admin Console",src:t.figureSrc,width:"50%"}),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://www.oauth.com/oauth2-servers/redirect-uris/"},"Redirect URI")," is an OAuth 2.0 concept which implies the location should redirect after authentication."))}l.isMDXComponent=!0},1482:function(e,n,t){t.d(n,{ZP:function(){return l}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=["components"],s={toc:[]};function l(e){var n=e.components,t=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/recipes/customize-sie/"},"Customize sign-in experience")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/tutorials/get-started/enable-passcode-sign-in"},"Enable SMS or email passcode sign-in")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/tutorials/get-started/enable-social-sign-in"},"Enable social sign-in")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/recipes/protect-your-api/"},"Protect your API"))))}l.isMDXComponent=!0},6301:function(e,n,t){t.d(n,{ZP:function(){return l}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=["components"],s={toc:[]};function l(e){var n=e.components,t=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",null,"Before calling ",(0,o.kt)("code",null,t.calling),", make sure you have correctly configured Redirect URI in Admin Console."))))}l.isMDXComponent=!0},9593:function(e,n,t){t.d(n,{ZP:function(){return c}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=t.p+"assets/images/web-sign-in-flow-e0b056d8128741cf51bb6921ce76a564.png",s=["components"],l={toc:[]};function c(e){var n=e.components,t=(0,a.Z)(e,s);return(0,o.kt)("wrapper",(0,r.Z)({},l,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The sign-in flow can be simplied as:"),(0,o.kt)("center",null,(0,o.kt)("img",{alt:"Web sign-in flow",src:i,width:"80%"})))}c.isMDXComponent=!0},9530:function(e,n,t){t.r(n),t.d(n,{assets:function(){return v},contentTitle:function(){return k},default:function(){return w},frontMatter:function(){return h},metadata:function(){return f},toc:function(){return y}});var r=t(5443),a=t(3010),o=(t(9496),t(9613)),i=t(2418),s=t(8661),l=t(1280),c=t(6301),p=t(1482),d=t(9593),u=t(9046),m=t.p+"assets/images/traditional-redirect-uri-556ed857b8581022f8791306a905b654.png",g=["components"],h={sidebar_label:"Traditional Web"},k="Traditional Web: Integrate with Logto",f={unversionedId:"docs/recipes/integrate-logto/traditional",id:"docs/recipes/integrate-logto/traditional",title:"Traditional Web: Integrate with Logto",description:"Your app may run on the server-side instead of the browser, using frameworks like Django, Express, Laravel, NextJS, etc. That is called a Traditional Web App. For now, you need to integrate Logto manually. This article guides you on how to finish it step by step. And we take Express in Node.js as an example.",source:"@site/docs/docs/recipes/integrate-logto/traditional.mdx",sourceDirName:"docs/recipes/integrate-logto",slug:"/docs/recipes/integrate-logto/traditional",permalink:"/docs/recipes/integrate-logto/traditional",draft:!1,editUrl:"https://github.com/logto-io/docs/tree/master/docs/docs/recipes/integrate-logto/traditional.mdx",tags:[],version:"current",frontMatter:{sidebar_label:"Traditional Web"},sidebar:"docsSidebar",previous:{title:"React",permalink:"/docs/recipes/integrate-logto/react"},next:{title:"Vanilla JS",permalink:"/docs/recipes/integrate-logto/vanilla-js"}},v={},y=[{value:"Get source code",id:"get-source-code",level:2},{value:"Start an Express project",id:"start-an-express-project",level:2},{value:"Install dependencies",id:"install-dependencies",level:2},{value:"Use session",id:"use-session",level:2},{value:"Implement functions to authenticate users",id:"implement-functions-to-authenticate-users",level:2},{value:"Sign in",id:"sign-in",level:2},{value:"Configure Redirect URI",id:"configure-redirect-uri",level:3},{value:"Implement sign in route",id:"implement-sign-in-route",level:3},{value:"Sign out",id:"sign-out",level:2},{value:"Access protected resource",id:"access-protected-resource",level:2},{value:"Further readings",id:"further-readings",level:2}],b={toc:y};function w(e){var n=e.components,t=(0,a.Z)(e,g);return(0,o.kt)("wrapper",(0,r.Z)({},b,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"traditional-web-integrate-with-logto"},"Traditional Web: Integrate with Logto"),(0,o.kt)(l.ZP,{type:"Traditional Web",mdxType:"AppNote"}),(0,o.kt)("p",null,"Your app may run on the server-side instead of the browser, using frameworks like Django, Express, Laravel, NextJS, etc. That is called a Traditional Web App. For now, you need to integrate Logto manually. This article guides you on how to finish it step by step. And we take Express in Node.js as an example."),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This article is not just for Express, and if you are using other frameworks or even other languages, you can replace ",(0,o.kt)("inlineCode",{parentName:"p"},"@logto/js")," with other language's core SDK and then adjust some of the steps."))),(0,o.kt)("h2",{id:"get-source-code"},"Get source code"),(0,o.kt)("p",null,"You can go to ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/logto-io/express-example"},"GitHub")," to get the final code for this tutorial."),(0,o.kt)("h2",{id:"start-an-express-project"},"Start an Express project"),(0,o.kt)("p",null,"With ",(0,o.kt)("inlineCode",{parentName:"p"},"express-generator"),", you can quickly start an Express project."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir express-logto\ncd express-logto\nnpx express-generator\n")),(0,o.kt)("h2",{id:"install-dependencies"},"Install dependencies"),(0,o.kt)("p",null,"The demo app will need 4 dependencies:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"@logto/js"),": Logto's core SDK for JavaScript."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"node-fetch"),": Minimal code for a ",(0,o.kt)("inlineCode",{parentName:"li"},"window.fetch")," compatible API on Node.js runtime."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"express-session"),": A session middleware, we'll use the session to store user tokens."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"js-base64"),": Yet another Base64 transcoder.")),(0,o.kt)(i.Z,{mdxType:"Tabs"},(0,o.kt)(s.Z,{value:"npm",label:"npm",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm i @logto/js node-fetch@v2 express-session js-base64\n"))),(0,o.kt)(s.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add @logto/js node-fetch@v2 express-session js-base64\n"))),(0,o.kt)(s.Z,{value:"pnpm",label:"pnpm",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"pnpm add @logto/js node-fetch@v2 express-session js-base64\n")))),(0,o.kt)("h2",{id:"use-session"},"Use session"),(0,o.kt)("p",null,"When users are signed in, they will get a set of tokens (Access Token, ID Token, Refresh Token) and interaction data, and the session is an excellent place to store them."),(0,o.kt)("p",null,"We have installed ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/expressjs/session"},"express-session")," in the previous step, so now let's simply add the following code to set it up:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// app.js\n\nconst session = require('express-session');\n\napp.use(\n  session({\n    secret: 'keyboard cat', // Change to your own secret key\n    cookie: { maxAge: 86400 },\n  })\n);\n")),(0,o.kt)("h2",{id:"implement-functions-to-authenticate-users"},"Implement functions to authenticate users"),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"We assume the application is running on ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:3000")," in the following code snippets."))),(0,o.kt)("p",null,"In this step, we need to implement the following authenticate functions:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"getSignInUrl"),": builds and returns a complete URL of the Logto Authorization Server to which users will be redirected."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"handleSignIn"),": parses the callback URL after the authentication process completes, gets the code query parameter, and then fetches tokens (an access token, the refresh token, and an ID token) to complete the sign in process."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"refreshTokens"),": exchanges a new access token using the refresh token.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// logto.js\n\nconst {\n  withReservedScopes,\n  fetchOidcConfig,\n  discoveryPath,\n  createRequester,\n  generateSignInUri,\n  verifyAndParseCodeFromCallbackUri,\n  fetchTokenByAuthorizationCode,\n  fetchTokenByRefreshToken,\n} = require('@logto/js');\nconst fetch = require('node-fetch');\nconst { randomFillSync, createHash } = require('crypto');\nconst { fromUint8Array } = require('js-base64');\n\nconst config = {\n  endpoint: 'https://logto.dev',\n  appId: 'foo',\n  redirectUri: 'http://localhost:3000/callback', // You may need to replace it with your app's production address\n  scopes: withReservedScopes().split(' '),\n};\n\nconst requester = createRequester(fetch);\n\nconst generateRandomString = (length = 64) => {\n  return fromUint8Array(randomFillSync(new Uint8Array(length)), true);\n};\n\nconst generateCodeChallenge = async (codeVerifier) => {\n  const encodedCodeVerifier = new TextEncoder().encode(codeVerifier);\n  const hash = createHash('sha256');\n  hash.update(encodedCodeVerifier);\n  const codeChallenge = hash.digest();\n  return fromUint8Array(codeChallenge, true);\n};\n\nconst getOidcConfig = async () => {\n  return fetchOidcConfig(new URL(discoveryPath, config.endpoint).toString(), requester);\n};\n\nexports.getSignInUrl = async () => {\n  const { authorizationEndpoint } = await getOidcConfig();\n  const codeVerifier = generateRandomString();\n  const codeChallenge = await generateCodeChallenge(codeVerifier);\n  const state = generateRandomString();\n\n  const { redirectUri, scopes, appId: clientId } = config;\n\n  const signInUri = generateSignInUri({\n    authorizationEndpoint,\n    clientId,\n    redirectUri: redirectUri,\n    codeChallenge,\n    state,\n    scopes,\n  });\n\n  return { redirectUri, codeVerifier, state, signInUri };\n};\n\nexports.handleSignIn = async (signInSession, callbackUri) => {\n  const { redirectUri, state, codeVerifier } = signInSession;\n  const code = verifyAndParseCodeFromCallbackUri(callbackUri, redirectUri, state);\n\n  const { appId: clientId } = config;\n  const { tokenEndpoint } = await getOidcConfig();\n  const codeTokenResponse = await fetchTokenByAuthorizationCode(\n    {\n      clientId,\n      tokenEndpoint,\n      redirectUri,\n      codeVerifier,\n      code,\n    },\n    requester\n  );\n\n  return codeTokenResponse;\n};\n\nexports.refreshTokens = async (refreshToken) => {\n  const { appId: clientId, scopes } = config;\n  const { tokenEndpoint } = await getOidcConfig();\n  const tokenResponse = await fetchTokenByRefreshToken(\n    {\n      clientId,\n      tokenEndpoint,\n      refreshToken,\n      scopes,\n    },\n    requester\n  );\n\n  return tokenResponse;\n};\n")),(0,o.kt)("h2",{id:"sign-in"},"Sign in"),(0,o.kt)(d.ZP,{mdxType:"SignInFlowSummary"}),(0,o.kt)("h3",{id:"configure-redirect-uri"},"Configure Redirect URI"),(0,o.kt)(u.ZP,{figureSrc:m,redirectUri:"http://localhost:3000/callback",mdxType:"ConfigureRedirectUri"}),(0,o.kt)("h3",{id:"implement-sign-in-route"},"Implement sign in route"),(0,o.kt)(c.ZP,{calling:"getSignInUrl()",mdxType:"SignInNote"}),(0,o.kt)("p",null,"Create a route in Express to sign in:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const { getSignInUrl } = require('./logto');\n\napp.get('/sign-in', async (req, res) => {\n  const { redirectUri, codeVerifier, state, signInUri } = await getSignInUrl();\n  req.session.signIn = { codeVerifier, state, redirectUri };\n  res.redirect(signInUri);\n});\n")),(0,o.kt)("p",null,"and a route to handle callback:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"app.get('/callback', async (req, res) => {\n  if (!req.session.signIn) {\n    res.send('Bad request.');\n    return;\n  }\n\n  const response = await handleSignIn(\n    req.session.signIn,\n    `${req.protocol}://${req.get('host')}${req.originalUrl}`\n  );\n  req.session.tokens = {\n    ...response,\n    expiresAt: response.expiresIn + Date.now(),\n    idToken: decodeIdToken(response.idToken),\n  };\n  req.session.signIn = null;\n\n  res.redirect('/');\n});\n")),(0,o.kt)("h2",{id:"sign-out"},"Sign out"),(0,o.kt)("p",null,'TODO: link to the "session & cookies" chapter in users reference.'),(0,o.kt)("p",null,'You can clear tokens in session to sign out a user from this application. And check this link to read more about "sign out".'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"app.get('/sign-out', (req, res) => {\n  req.session.tokens = null;\n  res.send('Sign out successful');\n});\n")),(0,o.kt)("h2",{id:"access-protected-resource"},"Access protected resource"),(0,o.kt)("p",null,"Create a middleware named ",(0,o.kt)("inlineCode",{parentName:"p"},"withAuth")," to attach an ",(0,o.kt)("inlineCode",{parentName:"p"},"auth")," object to ",(0,o.kt)("inlineCode",{parentName:"p"},"req"),", and verify if a user is signed in."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// auth.js\n\nconst { decodeIdToken } = require('@logto/js');\nconst { refreshTokens } = require('./logto');\n\nconst withAuth =\n  ({ requireAuth } = { requireAuth: true }) =>\n  async (req, res, next) => {\n    if (requireAuth && !req.session.tokens) {\n      res.redirect('/sign-in');\n      return;\n    }\n\n    if (req.session.tokens) {\n      if (req.session.tokens.expiresAt >= Date.now()) {\n        // Access token expired, refresh for new tokens\n        try {\n          const response = await refreshTokens(req.session.tokens.refreshToken);\n          req.session.tokens = {\n            ...response,\n            expiresAt: response.expiresIn + Date.now(),\n            idToken: decodeIdToken(response.idToken),\n          };\n        } catch {\n          // Exchange failed, redirect to sign in\n          res.redirect('/sign-in');\n          return;\n        }\n      }\n\n      req.auth = req.session.tokens.idToken.sub;\n    }\n\n    next();\n  };\n\nmodule.exports = withAuth;\n")),(0,o.kt)("p",null,"create ",(0,o.kt)("inlineCode",{parentName:"p"},"index")," page, show a sign-in link for guests, and a go-to-profile link for users that already signed in:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"router.get('/', withAuth({ requireAuth: false }), function (req, res, next) {\n  res.render('index', { auth: Boolean(req.auth) });\n});\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jade"},'extends layout\n\nblock content\n  h1 Hello logto\n  if auth\n    p: a(href="/user") Go to profile\n  else\n    p: a(href="/sign-in") Click here to sign in\n')),(0,o.kt)("p",null,"create ",(0,o.kt)("inlineCode",{parentName:"p"},"user")," page, to display ",(0,o.kt)("inlineCode",{parentName:"p"},"userId")," (",(0,o.kt)("inlineCode",{parentName:"p"},"subject"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"app.get('/user', withAuth(), (req, res, next) => {\n  res.render('user', { userId: req.auth });\n});\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jade"},"extends layout\n\nblock content\n  h1 Hello logto\n  p userId: #{userId}\n")),(0,o.kt)("h2",{id:"further-readings"},"Further readings"),(0,o.kt)(p.ZP,{mdxType:"FurtherReadings"}))}w.isMDXComponent=!0}}]);